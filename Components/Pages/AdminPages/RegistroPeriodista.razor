
 @page "/registro/periodista"
@page "/registro/periodista/{id:int}"
@inject PeriodistaService PeriodistaService
@inject NavigationManager navigationManager
@inject UserManager<ApplicationUser> UserManager
@rendermode InteractiveServer

<PageTitle>@(esEdicion ? "Editar Periodista" : "Registrar Periodista")</PageTitle>

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-6 col-lg-5">
            <div class="card border-0 shadow-lg">
                <div class="bg-gradient-green text-white text-center py-4 rounded-top">
                    <h3 class="fw-bold mb-2">@((esEdicion ? "Editar" : "Únete como") + " Periodista")</h3>
                    <p class="mb-0 opacity-75">Publica tus artículos y genera ingresos</p>
                </div>

                <div class="card-body p-4">
                    @if (!string.IsNullOrEmpty(errorMessage))
                    {
                        <div class="alert alert-danger border-0 d-flex align-items-center" role="alert">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <div>@errorMessage</div>
                        </div>
                    }

                    @if (registroExitoso)
                    {
                        <div class="alert alert-success border-0 d-flex align-items-center">
                            <i class="bi bi-check-circle me-2"></i>
                            <div>¡Registro exitoso! Redirigiendo...</div>
                        </div>
                    }
                    else
                    {
                        <div class="mb-4">
                            <div class="d-flex align-items-center mb-3">
                                <div class="section-icon bg-warning bg-opacity-10 text-warning me-2">
                                    <i class="bi bi-person fs-5"></i>
                                </div>
                                <h6 class="mb-0 fw-semibold">Tus Datos</h6>
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-semibold">Nombre Completo <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" @bind="periodista.Nombres"
                                       placeholder="Ej: María García López" />
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-semibold">Tarifa Base (RD$) <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <span class="input-group-text" style="color: #e65100;"><i class="bi bi-currency-dollar"></i></span>
                                    <input type="number" class="form-control" @bind="periodista.TarifaBase"
                                           placeholder="0" />
                                </div>
                                <small class="text-muted d-flex align-items-start mt-1">
                                    <i class="bi bi-info-circle me-1 mt-1" style="color: #e65100;"></i>
                                    <span>Esta es la tarifa que cobrarás por cada artículo publicado</span>
                                </small>
                            </div>
                        </div>

                        @if (!esEdicion)
                        {
                            <hr>
                            <div class="mb-4">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="section-icon bg-success bg-opacity-10 text-success me-2">
                                        <i class="bi bi-key fs-5"></i>
                                    </div>
                                    <h6 class="mb-0 fw-semibold">Datos de Acceso</h6>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-semibold">Email <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="bi bi-envelope"></i></span>
                                        <input type="email" class="form-control" @bind="email"
                                               placeholder="Periodista@gmail.com" />
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-semibold">Contraseña <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="bi bi-lock"></i></span>
                                        <input type="password" class="form-control" @bind="password" placeholder="••••••••" />
                                    </div>
                                    <small class="text-muted">Mínimo 6 caracteres</small>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-semibold">Confirmar Contraseña <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="bi bi-lock"></i></span>
                                        <input type="password" class="form-control" @bind="confirmarPassword" placeholder="••••••••" />
                                    </div>
                                </div>

                                <div class="bg-light p-3 rounded mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="aceptaTerminos" @bind="aceptaTerminos">
                                        <label class="form-check-label small" for="aceptaTerminos">
                                            Acepto los <a href="/terminos" class="text-decoration-none" style="color: #e65100;">términos y condiciones</a>
                                            y la <a href="/privacidad" class="text-decoration-none" style="color: #e65100;">política de privacidad</a>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        }

                        <div class="d-grid mb-3">
                            <button type="button" class="btn btn-orange btn-lg py-3" @onclick="GuardarPeriodista" disabled="@registrando">
                                @if (registrando)
                                {
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                    <span>@((esEdicion ? "Guardando..." : "Registrando..."))</span>
                                }
                                else
                                {
                                    <i class="bi bi-check-circle me-2"></i>
                                    <span>@((esEdicion ? "Guardar Cambios" : "Registrarme como Periodista"))</span>
                                }
                            </button>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter] public int? id { get; set; }

    private bool esEdicion => id.HasValue;

    public Periodista periodista { get; set; } = new Periodista();
    public string email { get; set; } = string.Empty;
    public string password { get; set; } = string.Empty;
    public string confirmarPassword { get; set; } = string.Empty;
    public bool aceptaTerminos { get; set; } = false;
    public string errorMessage { get; set; } = string.Empty;
    public bool registrando { get; set; } = false;
    public bool registroExitoso { get; set; } = false;

    protected override async Task OnInitializedAsync()
    {
        if (esEdicion)
        {
            var existing = await PeriodistaService.Buscar(id.Value);
            if (existing != null)
            {
                periodista = existing;
            }
            else
            {
                errorMessage = "Periodista no encontrado";
            }
        }
    }

    private async Task GuardarPeriodista()
    {
        errorMessage = string.Empty;
        registrando = true;

        try
        {
            if (string.IsNullOrWhiteSpace(periodista.Nombres))
                throw new Exception("Tu nombre completo es requerido");
            if (periodista.TarifaBase <= 0)
                throw new Exception("Debes establecer una tarifa base mayor a 0");

            if (!esEdicion)
            {
                if (string.IsNullOrWhiteSpace(email))
                    throw new Exception("El email es requerido");
                if (string.IsNullOrWhiteSpace(password) || password.Length < 6)
                    throw new Exception("La contraseña debe tener al menos 6 caracteres");
                if (password != confirmarPassword)
                    throw new Exception("Las contraseñas no coinciden");
                if (!aceptaTerminos)
                    throw new Exception("Debes aceptar los términos y condiciones");

                var creado = await PeriodistaService.CrearConUsuario(periodista, email, password);
                if (!creado)
                    throw new Exception("No se pudo completar el registro. El email podría estar registrado.");

                registroExitoso = true;
                navigationManager.NavigateTo("/Account/Login", forceLoad: true);
            }
            else
            {
                // Edición simple
                await PeriodistaService.Guardar(periodista);
                registroExitoso = true;
                navigationManager.NavigateTo("/admin/periodistas", forceLoad: true);
            }
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            registrando = false;
        }
    }
}
